
#----------------------------
#  EXPERIMENT STEPS (LOOP)
#----------------------------

# packetloss_rates = [0, 10, 20, 30, 40, 50, 60, 70, 80, 85, 90, 95]

# For current_packetloss_rate in packetloss_rates:
	# Pick the next packetloss rate (current_packetloss_rate) from packetloss_rates
	
	# Simulate {current_packetloss_rate}% packetloss rate on the ifb0 interface:
	$ sudo tc qdisc add dev ifb0 root netem loss {current_packetloss_rate}% 
	
	# Run packet capture with tcpdump on port 53 on the ifb0 interface, 
	# and save the logs to tcpdump_log_{current_packetloss_rate}.pcap:
	$ sudo tcpdump -w tcpdump_log_{current_packetloss_rate}.pcap -nnn -i ifb0 "src port 53"

	# Run the python script (sendQueriesToResolvers.py) to start sending DNS queries:
	$ python3 ./sendQueriesToResolvers.py

	# When the script ends, stop packet capture of tcpdump by pressing CTRL+C
	
	# Disable the packetloss simulation:
    $ sudo tc qdisc del dev ifb0 root
    $ sudo tc -s qdisc ls dev ifb0

#-------------------------------
#  EXPERIMENT STEPS (ITERATIVE)
#-------------------------------

# 1- Start with 0 packetloss rate
# 2- Run packet capture with tcpdump on port 53 on the ifb0 interface, 
#    save the logs to tcpdump_log_00.pcap (last 2 digits of the file is the packetloss rate)

$ sudo tcpdump -w tcpdump_log_00.pcap -nnn -i ifb0 "src port 53"

# 3- Run the python script (sendQueriesToResolvers.py) to start sending DNS queries

$ python3 ./sendQueriesToResolvers.py

# 4- When the script ends, stop packet capture of tcpdump by pressing CTRL+C
# 5- Simulate 10% packetloss rate on the ifb0 interface

$ sudo tc qdisc add dev ifb0 root netem loss 10% 

# 6- Run packet capture with tcpdump on port 53 on the ifb0 interface, 
#    save the logs to tcpdump_log_10.pcap 

$ sudo tcpdump -w tcpdump_log_10.pcap -nnn -i ifb0 "src port 53"

# 7- Run the python script (sendQueriesToResolvers.py) to start sending DNS queries

$ python3 ./sendQueriesToResolvers.py

# 8- When the script ends, stop packet capture of tcpdump by pressing CTRL+C
# 9- Disable the packetloss simulation

sudo tc qdisc del dev ifb0 root
sudo tc -s qdisc ls dev ifb0


# 10- Simulate 20% packetloss rate on the ifb0 interface

$ sudo tc qdisc add dev ifb0 root netem loss 20% 

# 11- Run packet capture with tcpdump on port 53 on the ifb0 interface, 
#    save the logs to tcpdump_log_20.pcap 

$ sudo tcpdump -w tcpdump_log_20.pcap -nnn -i ifb0 "src port 53"

# 12- Run the python script (sendQueriesToResolvers.py) to start sending DNS queries

$ python3 ./sendQueriesToResolvers.py

# 13- When the script ends, stop packet capture of tcpdump by pressing CTRL+C
# 14- Disable the packetloss simulation

sudo tc qdisc del dev ifb0 root
sudo tc -s qdisc ls dev ifb0


# 15- Simulate 30% packetloss rate on the ifb0 interface

$ sudo tc qdisc add dev ifb0 root netem loss 30% 

# 16- Run packet capture with tcpdump on port 53 on the ifb0 interface, 
#    save the logs to tcpdump_log_30.pcap 

$ sudo tcpdump -w tcpdump_log_30.pcap -nnn -i ifb0 "src port 53"

# 17- Run the python script (sendQueriesToResolvers.py) to start sending DNS queries

$ python3 ./sendQueriesToResolvers.py

# 18- When the script ends, stop packet capture of tcpdump by pressing CTRL+C
# 19- Disable the packetloss simulation

sudo tc qdisc del dev ifb0 root
sudo tc -s qdisc ls dev ifb0


# 20- Simulate 40% packetloss rate on the ifb0 interface

$ sudo tc qdisc add dev ifb0 root netem loss 40% 

# 21- Run packet capture with tcpdump on port 53 on the ifb0 interface, 
#    save the logs to tcpdump_log_40.pcap 

$ sudo tcpdump -w tcpdump_log_40.pcap -nnn -i ifb0 "src port 53"

# 22- Run the python script (sendQueriesToResolvers.py) to start sending DNS queries

$ python3 ./sendQueriesToResolvers.py

# 23- When the script ends, stop packet capture of tcpdump by pressing CTRL+C
# 24- Disable the packetloss simulation

sudo tc qdisc del dev ifb0 root
sudo tc -s qdisc ls dev ifb0


# 20- Simulate 40% packetloss rate on the ifb0 interface

$ sudo tc qdisc add dev ifb0 root netem loss 40% 

# 21- Run packet capture with tcpdump on port 53 on the ifb0 interface, 
#    save the logs to tcpdump_log_40.pcap 

$ sudo tcpdump -w tcpdump_log_40.pcap -nnn -i ifb0 "src port 53"

# 22- Run the python script (sendQueriesToResolvers.py) to start sending DNS queries

$ python3 ./sendQueriesToResolvers.py

# 23- When the script ends, stop packet capture of tcpdump by pressing CTRL+C
# 24- Disable the packetloss simulation

sudo tc qdisc del dev ifb0 root
sudo tc -s qdisc ls dev ifb0


# 25- Simulate 50% packetloss rate on the ifb0 interface

$ sudo tc qdisc add dev ifb0 root netem loss 50% 

# 26- Run packet capture with tcpdump on port 53 on the ifb0 interface, 
#    save the logs to tcpdump_log_50.pcap 

$ sudo tcpdump -w tcpdump_log_50.pcap -nnn -i ifb0 "src port 53"

# 27- Run the python script (sendQueriesToResolvers.py) to start sending DNS queries

$ python3 ./sendQueriesToResolvers.py

# 28- When the script ends, stop packet capture of tcpdump by pressing CTRL+C
# 29- Disable the packetloss simulation

sudo tc qdisc del dev ifb0 root
sudo tc -s qdisc ls dev ifb0


# 30- Simulate 60% packetloss rate on the ifb0 interface

$ sudo tc qdisc add dev ifb0 root netem loss 60% 

# 31- Run packet capture with tcpdump on port 53 on the ifb0 interface, 
#    save the logs to tcpdump_log_60.pcap 

$ sudo tcpdump -w tcpdump_log_60.pcap -nnn -i ifb0 "src port 53"

# 32- Run the python script (sendQueriesToResolvers.py) to start sending DNS queries

$ python3 ./sendQueriesToResolvers.py

# 33- When the script ends, stop packet capture of tcpdump by pressing CTRL+C
# 34- Disable the packetloss simulation

sudo tc qdisc del dev ifb0 root
sudo tc -s qdisc ls dev ifb0


# 35- Simulate 70% packetloss rate on the ifb0 interface

$ sudo tc qdisc add dev ifb0 root netem loss 70% 

# 36- Run packet capture with tcpdump on port 53 on the ifb0 interface, 
#    save the logs to tcpdump_log_70.pcap 

$ sudo tcpdump -w tcpdump_log_70.pcap -nnn -i ifb0 "src port 53"

# 37- Run the python script (sendQueriesToResolvers.py) to start sending DNS queries

$ python3 ./sendQueriesToResolvers.py

# 38- When the script ends, stop packet capture of tcpdump by pressing CTRL+C
# 39- Disable the packetloss simulation

sudo tc qdisc del dev ifb0 root
sudo tc -s qdisc ls dev ifb0


# 40- Simulate 80% packetloss rate on the ifb0 interface

$ sudo tc qdisc add dev ifb0 root netem loss 80% 

# 41- Run packet capture with tcpdump on port 53 on the ifb0 interface, 
#    save the logs to tcpdump_log_80.pcap 

$ sudo tcpdump -w tcpdump_log_80.pcap -nnn -i ifb0 "src port 53"

# 42- Run the python script (sendQueriesToResolvers.py) to start sending DNS queries

$ python3 ./sendQueriesToResolvers.py

# 43- When the script ends, stop packet capture of tcpdump by pressing CTRL+C
# 44- Disable the packetloss simulation

sudo tc qdisc del dev ifb0 root
sudo tc -s qdisc ls dev ifb0


# 40- Simulate 85% packetloss rate on the ifb0 interface

$ sudo tc qdisc add dev ifb0 root netem loss 85% 

# 41- Run packet capture with tcpdump on port 53 on the ifb0 interface, 
#    save the logs to tcpdump_log_85.pcap 

$ sudo tcpdump -w tcpdump_log_85.pcap -nnn -i ifb0 "src port 53"

# 42- Run the python script (sendQueriesToResolvers.py) to start sending DNS queries

$ python3 ./sendQueriesToResolvers.py

# 43- When the script ends, stop packet capture of tcpdump by pressing CTRL+C
# 44- Disable the packetloss simulation

sudo tc qdisc del dev ifb0 root
sudo tc -s qdisc ls dev ifb0


# 45- Simulate 90% packetloss rate on the ifb0 interface

$ sudo tc qdisc add dev ifb0 root netem loss 90% 

# 46- Run packet capture with tcpdump on port 53 on the ifb0 interface, 
#    save the logs to tcpdump_log_90.pcap 

$ sudo tcpdump -w tcpdump_log_90.pcap -nnn -i ifb0 "src port 53"

# 47- Run the python script (sendQueriesToResolvers.py) to start sending DNS queries

$ python3 ./sendQueriesToResolvers.py

# 48- When the script ends, stop packet capture of tcpdump by pressing CTRL+C
# 49- Disable the packetloss simulation

sudo tc qdisc del dev ifb0 root
sudo tc -s qdisc ls dev ifb0


# 50- Simulate 95% packetloss rate on the ifb0 interface

$ sudo tc qdisc add dev ifb0 root netem loss 95% 

# 51- Run packet capture with tcpdump on port 53 on the ifb0 interface, 
#    save the logs to tcpdump_log_95.pcap 

$ sudo tcpdump -w tcpdump_log_95.pcap -nnn -i ifb0 "src port 53"

# 52- Run the python script (sendQueriesToResolvers.py) to start sending DNS queries

$ python3 ./sendQueriesToResolvers.py

# 53- When the script ends, stop packet capture of tcpdump by pressing CTRL+C
# 54- Disable the packetloss simulation

sudo tc qdisc del dev ifb0 root
sudo tc -s qdisc ls dev ifb0

#----------------------
#  END OF EXPERIMENTS
#----------------------

#----------------------
#  BEGIN EVALUATION
#----------------------

# Filter each resolver communication on each capture log by applying filters on wireshark

# Open all the saved log files one by one in wireshark, 
     export the file as JSON (file name: wireshark0PL.json "1PL" stands for 10% packet loss) 
# Run the plotter script (createPlots.py) that uses the json files to create plots
   that compares the latencies/failure rates regarding packetloss.

